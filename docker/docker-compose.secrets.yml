# =============================================================================
# GenWrite Frontend - Docker Compose with Secrets (Swarm Mode)
# =============================================================================
# For production deployment with Docker Swarm secrets
# Usage:
#   1. docker swarm init
#   2. Create secrets (see DOCKER_GUIDE.md)
#   3. docker stack deploy -c docker-compose.secrets.yml genwrite
# =============================================================================

version: "3.8"

services:
  frontend:
    image: genwrite-frontend:latest
    ports:
      - "80:80"
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 128M
    secrets:
      - vite_api_url
      - vite_google_client_id
      - vite_stripe_public_key
      - vite_recaptcha_site_key
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - genwrite-net
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"

secrets:
  vite_api_url:
    external: true
  vite_google_client_id:
    external: true
  vite_stripe_public_key:
    external: true
  vite_recaptcha_site_key:
    external: true

networks:
  genwrite-net:
    driver: overlay
    attachable: true
